name: CI Security Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: incidentdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 1234
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Firefox
        run: |
          sudo apt-get update
          sudo apt-get install -y firefox

      - name: Install Geckodriver manually
        run: |
          GECKODRIVER_VERSION="v0.35.0"
          wget "https://github.com/mozilla/geckodriver/releases/download/$GECKODRIVER_VERSION/geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz"
          tar -xzf geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz
          chmod +x geckodriver
          sudo mv geckodriver /usr/local/bin/

      - name: Verify Firefox and geckodriver
        run: |
          which firefox
          firefox --version
          which geckodriver
          geckodriver --version

      - name: Check Firefox and geckodriver
        run: |
          echo "=== Comprovant Firefox ==="
          if ! command -v firefox &> /dev/null; then
            echo "Firefox no està instal·lat"
            exit 1
          else
            echo "Firefox instal·lat a: $(which firefox)"
            firefox --version
          fi
          echo "=== Comprovant geckodriver ==="
          if ! command -v geckodriver &> /dev/null; then
            echo "Geckodriver no està instal·lat"
            exit 1
          else
            echo "Geckodriver instal·lat a: $(which geckodriver)"
            geckodriver --version
          fi

      - name: Debug environment
        run: |
          echo "PATH: $PATH"
          echo "Firefox location: $(which firefox)"
          echo "Geckodriver location: $(which geckodriver)"

      - name: Run tests
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DEBUG: False
          ALLOWED_HOSTS: localhost
          DATABASE_URL: postgres://postgres:1234@localhost:5432/incidentdb
          FIREFOX_BINARY: /usr/bin/firefox
        run: |
          python manage.py test core.tests_selenium