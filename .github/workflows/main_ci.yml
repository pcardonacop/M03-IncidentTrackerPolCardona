name: CI Security Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: incidentdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: 1234
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # Instal路lar Firefox tradicional (no snap)
      - name: Install Firefox (traditional)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget bzip2
          wget -O firefox.tar.bz2 "https://download.mozilla.org/?product=firefox-latest&os=linux64&lang=ca"
          tar -xjf firefox.tar.bz2
          sudo mv firefox /opt/
          sudo ln -sf /opt/firefox/firefox /usr/local/bin/firefox

      # Instal路lar geckodriver (versi贸 fixa)
      - name: Install Geckodriver manually
        run: |
          GECKODRIVER_VERSION="v0.35.0"
          wget "https://github.com/mozilla/geckodriver/releases/download/$GECKODRIVER_VERSION/geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz"
          tar -xzf geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz
          chmod +x geckodriver
          sudo mv geckodriver /usr/local/bin/

      # Verificar instal路lacions
      - name: Verify installations
        run: |
          echo "=== Firefox ==="
          which firefox
          firefox --version
          echo "=== Geckodriver ==="
          which geckodriver
          geckodriver --version
          echo "=== PATH ==="
          echo $PATH

      # Executar tests
      - name: Run tests
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DEBUG: False
          ALLOWED_HOSTS: localhost
          DATABASE_URL: postgres://postgres:1234@localhost:5432/incidentdb
          FIREFOX_BINARY: /usr/local/bin/firefox
        run: |
          python manage.py test core.tests_selenium